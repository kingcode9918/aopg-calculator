--|| SERVICES ||--
local UserInputService = game:GetService("UserInputService")
local RunService = game:GetService("RunService")
local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")

--|| MODULES ||--
local module = {}

local tiers = {
	[1] = {Cost = 1000, ChanceToUpgrade = 65, DamageMulti = 1.1} ;
	[2] = {Cost = 1500, ChanceToUpgrade = 50, DamageMulti = 1.2} ;
	[3] = {Cost = 2000, ChanceToUpgrade = 25, DamageMulti = 1.35} ;
	[4] = {Cost = 2500, ChanceToUpgrade = 15, DamageMulti = 1.5} ;
	[5] = {Cost = 5000, ChanceToUpgrade = 5, DamageMulti = 1.7} ;
}
 
function module:GetBlacksmithWeapon(plr, regs)
	local tool = plr.Character:FindFirstChildWhichIsA("Tool")
	local reg = false

	local allowed = {
		["Devil Fruit"] = true ;
		["Fighting Style"] = true ;
		["Sword Style"] = true ;
		["Support Style"] = true ;
		["Gun Style"] = true ;
	}

	if tool then
		if regs[tool.Name] then
			if allowed[regs[tool.Name]] then
				reg = true
			end
		end
	end
	
	return {tool, reg}
end
 
function module:GetUpgradeInfo(plr, weapon)
	local data = _G.DataFunctions.Get(plr.UserId)
	local current = data.Extra.Blacksmith.Upgrades[weapon.Name] or 0
	local new = tiers[current + 1]
	
	if (current + 1) > 5 then
		new = "Maxed"
	end
	
	return new
end

function module:BlacksmithWeaponUpgrade(plr, weapon)
	local data = _G.DataFunctions.Get(plr.UserId)
	local current = data.Extra.Blacksmith.Upgrades[weapon.Name] or 0
	local new = tiers[current + 1]

	if new then
		if data.Extra.Blacksmith.Upgrades[weapon.Name] == nil then
			data.Extra.Blacksmith.Upgrades[weapon.Name] = 0
		end
		
		data.Extra.Blacksmith.Upgrades[weapon.Name] = math.clamp(data.Extra.Blacksmith.Upgrades[weapon.Name] + 1, 0, 5)
	end
end

function module:AttemptBlacksmithUpgrade(plr, weapon)
	local data = _G.DataFunctions.Get(plr.UserId)
	local current = data.Extra.Blacksmith.Upgrades[weapon.Name] or 0
	local new = tiers[current + 1]
	local doUpgrade = false
	
	if new then
		local chance = new.ChanceToUpgrade
		
		pcall(function()
			if
				_G.OwnsGamepass(plr.UserId, 178381753) or data.Extra.chancesTime > 0 or plr.Name == "Vxcry1" then
				chance *= 1.4
			end
		end)
		
		if math.random(1, 100) <= chance then
			doUpgrade = true
		end
	end
	
	return doUpgrade
end

function module:GetBlacksmithUpgrade(plr, weapon)
	local data = _G.DataFunctions.Get(plr.UserId)
	local damageMult = 1
	
	if data and weapon then
		if data.Extra.Blacksmith then
			if data.Extra.Blacksmith.Upgrades[weapon.Name] then
				local tier = data.Extra.Blacksmith.Upgrades[weapon.Name]
				local tab = tiers[tier]
				
				if tab then
					damageMult = tab.DamageMulti
				end
			end
		end
	end
	
	return damageMult
end

function module:calculateStamina(level)	
	return tonumber(50 + level * 25)
end
      
function module:calculateHealth(char, level)
	local base = tonumber(100 + level * 250)
	
	if char:FindFirstChild("PoisonPinkMode") then
		base *= 1.5
	end
	
	if char:FindFirstChild("EnergyFist") then
		base *= 1.3
	end
	
	local plr = game.Players:GetPlayerFromCharacter(char)

	if plr then
		local data = _G.DataFunctions.Get(plr.UserId)
		
		if data then
			if data.Stats.Race == "Hybrid" then
				base *= 1.5
			elseif data.Stats.Race == "Jinchuriki" then
				base *= 1.5
			elseif data.Stats.Race == "Germa" and data.Stats.GermaAwakened == true then
				base *= 1.6
			elseif data.Stats.Race == "Heavenly Restricted" then
				base *= 1.5
			elseif data.Stats.Race == "Buccaneer" then
				base *= 2
			elseif data.Stats.Race == "Perfect Lunatrix" then
				base *= 1.7
			elseif data.Stats.Race == "Oni" then
				base *= 2
			elseif data.Stats.Race == "Hunter" then
				base *= 1.9
			elseif data.Stats.Race == "Shandian" then
				base *= 0.8
			end
		end
	end
	
	return base
end

function module:calculateMaxExperience(Level)
	return tonumber(Level * 4)
end

function module:calculateGeppo(level)
	local base = 3
	local addition = level/300
	local rounded = math.floor(addition + 0.5)
	return tonumber(base + rounded)
end

function module:GetPercentage(base, change, addition)
	if addition == "Increase" then
		return (((change / 100) * base) + base)
	elseif addition == "Decrease" then
		return ((1 - (change / 100)) * base)
	end
end
        
function module:calculateDamage(damage, level, attackType)
	local calculated = tonumber(damage + level/2 + damage*level/12.5)
	if attackType == "Fruit" then
		calculated = calculated * 1.15
	end
	return calculated
end

return module
